<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorator="layout">

<head>
    <title>OpenIndoorMap - Map</title>
    <link rel="stylesheet" href="/externlib/cesium-1.44/Widgets/widgets.css">
    <style type="text/css">
    </style>
</head>

<body>
    <div layout:fragment="content">
        <!-- S: 맵 -->
        <div id="magoContainer"></div>
        <!-- E: 맵 -->
    </div>

    <th:block layout:fragment="script">
        <script type="text/javascript" src="/externlib/cesium-1.44/Cesium.js"></script>
        <script type="text/javascript" src="/externlib/mago3d/mago3d.js"></script>

        <script type="text/javascript">          
            $(window).bind('resizeEnd', function() {
                $('#magoContainer').height($('.main-sidebar').height() - $('footer').outerHeight(true));
            });

            function contentsResize() {
                if(this.resizeTO) clearTimeout(this.resizeTO);
                this.resizeTO = setTimeout(function() {
                    $(this).trigger('resizeEnd');
                }, 100);
            }

            window.onload = contentsResize;
            window.onresize = contentsResize;

            var MAP_NOTE_ID = null;
            var agent = navigator.userAgent.toLowerCase();
            if (agent.indexOf('chrome') < 0) {
                alert("This page is optimized for the Chrome browser for massive data processing.\n Please use the Chrome browser for seamless service.");
            }

            var drawHelper = null;
            var isDrawFeature = {
                isDraw: false,
                type: '',
                target: ''
            }

            var managerFactory = null;
            var imagePath = "/images";
            var dataInformationUrl = "/persistence/json/";
            magoStart(null, "magoContainer", imagePath);
            var intervalCount = 0;
            var timerId = setInterval("startMogoUI()", 1000);

            function startMogoUI() {
                intervalCount++;
                if (managerFactory != null && managerFactory.getMagoManagerState() === CODE.magoManagerState.READY) {
                    var viewer = managerFactory.getViewer();
                    // Label 표시
//                    changeLabelAPI(managerFactory, false);
                    // object 정보 표시
                    changeObjectInfoViewModeAPI(managerFactory, true);
                    // Origin 표시
                    changeOriginAPI(managerFactory, false);
                    // BoundingBox
                    changeBoundingBoxAPI(managerFactory, false);
                    // Selecting And Moving
                    changeObjectMoveAPI(managerFactory, "2");
                    // 3PView Mode
                    changeFPVModeAPI(managerFactory, false);

                    clearInterval(timerId);
                    console.log(" managerFactory != null, managerFactory.getMagoManagerState() = " + managerFactory.getMagoManagerState() + ", intervalCount = " + intervalCount);
                    return;
                }
                console.log("--------- intervalCount = " + intervalCount);
            }

            // mago3d 시작, 정책 데이터 파일을 로딩
            function magoStart(viewer, renderDivId, imagePath) {
                $.ajax({
                    url: dataInformationUrl + "policy-cesium.json",
                    type: "GET",
                    dataType: "json",
                    success: function (serverPolicy) {
                        loadData(viewer, renderDivId, serverPolicy);
                    },
                    error: function (e) {
                        alert(e.responseText);
                    }
                });
            }

            function loadData(viewer, renderDivId, serverPolicy) {
                if (serverPolicy.geo_data_default_projects === null || serverPolicy.geo_data_default_projects.length < 1) {
                    managerFactory = new ManagerFactory(viewer, renderDivId, serverPolicy, null, null, null, imagePath);
                } else {
                    var defaultProjectArray = serverPolicy.geo_data_default_projects;
                    var projectIdArray = new Array(defaultProjectArray.length);
                    var projectDataArray = new Array(defaultProjectArray.length);
                    var projectDataFolderArray = new Array(defaultProjectArray.length);

                    var dataCount = 0;
                    defaultProjectArray.forEach(function (projectId, index) {
                        projectIdArray[index] = projectId;
                        //console.log("url = " + dataInformationUrl + projectId);
                        $.ajax({
                            url: dataInformationUrl + projectId,
                            type: "GET",
                            dataType: "json",
                            success: function (serverData) {
                                //console.log("index = " + index + ", data = " + serverData);
                                projectDataArray[index] = serverData;
                                projectDataFolderArray[index] = serverData.data_key;
                                if (defaultProjectArray.length === (dataCount + 1)) {
                                    createManagerFactory(viewer, renderDivId, serverPolicy, projectIdArray, projectDataArray, projectDataFolderArray, imagePath);
                                }
                                dataCount++;
                            },
                            error: function (e) {
                                alert(e.responseText);
                            }
                        });
                    });
                }
            }

            function createManagerFactory(viewer, renderDivId, serverPolicy, projectIdArray, projectDataArray, projectDataFolderArray, imagePath) {
                managerFactory = new ManagerFactory(viewer, renderDivId, serverPolicy, projectIdArray, projectDataArray, projectDataFolderArray, imagePath);
            }
        </script>
     </th:block>
</body>

</html>